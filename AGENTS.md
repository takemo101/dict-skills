# dict-skills - AI Context

## プロジェクト構造

- `link-crawler/` - メインのクローラー実装

## 既知の制約

| 制約 | 理由 | 詳細 |
|------|------|------|
| デフォルトセッション使用 | playwright-cli 0.0.63+ の仕様変更 | [001](docs/decisions/001-playwright-cli-session.md) |
| 並列クロール不可 | 上記の制約による | [001](docs/decisions/001-playwright-cli-session.md) |
| スキル実行時は `-o` で絶対パス指定必須 | cwdがスキルディレクトリになるため | [006](docs/decisions/006-skill-output-directory.md) |

<!-- 
  ⚠️ このテーブルには「現在有効な制約・注意点」のみを記載
  - エージェントが重要な知見を発見した際、上の表に1行追加し、docs/decisions/ に詳細を記録する
  - 解決済み・不要になった項目は削除する（docs/decisions/ には履歴として残す）
  - 全ての意思決定ログ（解決済み含む）は docs/decisions/README.md を参照
-->
- HTMLエンティティのデコード順序を修正（&amp;の二重デコード防止） (319ac49)
- add explicit timeout to integration test execSync calls (9d61bcb)
- add respectRobots status to logStart() output (09295cb)
- add missing binary/non-crawlable file extensions to skipExtensions (0bfc9de)
- add upper bound validation for --max-pages CLI option (0a93a5d)
- decode numeric HTML entities in getTextWithoutLineNumbers (#1105) (299f7f1)
- rename .tmp-fix-shebang-test to .test-fix-shebang-tmp for consistency (46e39cc)
- add .tmp-* to .gitignore and global cleanup (2ca28c3)
- improve fix-shebang.js with fallback shebang addition and chmod (d153be7)
- Biome lint violations in test files (#1067) (e41f2e3)
- Biome フォーマット違反とlint違反の修正 (#1065) (a6b1f43)
- config.ts の console.warn を CrawlLogger 経由に統一 (81eac51)
- Biome フォーマットエラーの修正 (#1052) (4917696)
- add upper bound validation for CLI numeric options (#1041) (3f7e765)
- ビルド出力のshebangをNode.js互換に修正 (3787abf)
- ensure IndexManager.mergeExistingPages is idempotent and O(n) (#1033) (21201c1)
- update full.md assertion to match actual output format (#1032) (b67936f)
- remove attemptedCount reset from cleanup to preserve maxPages limit (#1031) (a1bf669)
- IndexManager.mergeExistingPages() による totalPages の二重カウント (#1023) (ce3606e)
- update full.md assertion to match actual format (#1020) (d1a78d3)
- handle network instability in crawl CLI tests (#1013) (92aace6)
- Biome format error in crawl-cli.test.ts (#1011) (b242948)
- CI修正 - format 対応 (abd3fce)
- skip postProcessor in cleanup() for non-diff mode (#980) (f6603ca)
- Biome lint/format errors in crawl-cli.test.ts (#972) (09ab266)
- prevent listener leak in SignalHandler.install() (#971) (5a1cbe6)
- Biome lint/formatエラーの修正 (crawl-cli.test.ts) (#963) (c0058ce)
- apply biome formatting fixes (1716dd0)
- remove unused private config parameter in OutputWriter (4926e7c)
- writer テストで一時ディレクトリがリークする (#952) (3ca7f6b)
- maxPages制限がリトライによるvisited削除の影響を受けないように修正 (#951) (e0c651a)
- only call saveIndex() in diff mode during cleanup (#942) (ad4b93b)
- remove unused check() function from verify-gitignore.sh (#940) (c90f89f)
- exclude barrel file src/diff/index.ts from coverage (#932) (ba197cc)
- install.sh のシバン行を #!/usr/bin/env bash に統一 (#931) (bffb4be)
- CI lint エラーを解消 (#922) (34dbbc3)
- verify .gitignore properly excludes development artifacts (#921) (edcc859)
- テストコードのLintエラー修正（未使用変数・フォーマット不一致） (#915) (3312718)
- Biome lint/format エラーを修正 (#905) (544926a)
- カバレッジ除外設定とドキュメント記載の不一致 (#897) (0f81b70)
- prioritize PATH-based fallback for Node.js and playwright-cli (#896) (2705d0e)
- Biome format errors in robots.test.ts (#866) (8e8dfcf)
- Replace regex with manual wildcard matching in RobotsChecker (#852) (87b23a4)
- replace numfmt with portable format_size function (0745293)
- remove tab characters from empty lines in fetcher.ts (#831) (f42d245)
- add playwright-cli installation to CI test job (#820) (93718d6)
- add path traversal prevention in getHttpMetadata (#804) (73b0b60)
- Biome CI failures in test files (#795) (028c713)
- Biome lint/format エラー修正 (crawl-cli.test.ts) (#793) (68e94c0)
- strip HTML tags from robots.txt content for playwright-cli compatibility (#782) (143e661)
- vitest.config.ts の coverage.exclude が空配列で docs/development.md と不一致 (c04b8b6)
- suppress Biome lint warning for unused constructor parameter (de037ee)
- add missing version property to baseConfig in crawler-link-extraction-order.test.ts (#757) (c89b31b)
- resolve Biome CI lint/format errors (5 fixes) (#755) (4ae8d8d)
- apply Biome formatting to post-processor (273159e)
- apply Biome lint fixes (001088b)
- add ReDoS protection to RobotsChecker pattern matching (b4e631a)
- Biome format violations in config.ts and test files (#743) (ce77abd)
- テストコードの CrawlConfig 型エラー修正（version プロパティ欠落） (abf7cf6)
- Biome フォーマッターエラーの修正（config.ts, config.test.ts） (#733) (49a98bc)
- テストコードの Biome lint エラー修正（未使用変数 5件） (#727) (2ab5890)
- remove asterisk from regex escape pattern in robots.ts matchPath (#725) (66e37e6)
- reorder extractLinks before extractContent to prevent DOM mutation issues (#717) (5e5cb65)
- Biome フォーマット違反の修正 (a0ba94c)
- remove incorrect default value from --no-robots option (#706) (270af44)
- replace any type with PageMetadata in savePage method (#705) (e10d0ce)
- TypeScript型エラー - tests/unit/crawler.test.ts:416 (#697) (e8c5eb4)
- add idempotency guard and Promise error handling for signal handlers (#696) (e9f73db)
- add URL protocol validation in executeFetch (#695) (f1b7822)
- add type assertion for resolveFetcher callback (804a958)
- remove unused computeHash import (589b653)
- Crawlerクラスのfetcher初期化に競合状態のリスク (#687) (2309486)
- apply biome format and lint fixes after merge (5895be3)
- Update test mocks to include maxPages and respectRobots fields (#672) (99d3de5)
- add missing maxPages and respectRobots to test CrawlConfig (#671) (043ca1c)
- apply biome lint fixes (115b054)
- add wildcard (*) and end-of-line ($) pattern support to robots.txt parser (#669) (5f41aff)
- lint errors and merge main (cad878e)
- add graceful shutdown (SIGINT/SIGTERM) handling (#646) (83d60e0)
- buildFrontmatter の YAML エスケープを強化 (#640) (8f02c98)
- apply Biome formatting to merged files (2b290a7)
- apply Biome formatting to test files (7f92506)
- apply Biome formatting (2d98743)
- apply Biome formatting (493e160)
- remove dead code in fallback extraction path (cc5ae2d)
- refactor protectCodeBlocks to prevent duplicate processing of nested code blocks (#630) (4fa0faa)
- track actual URL after redirects in PlaywrightFetcher (#629) (bc386bd)
- restore code blocks in fallback path after marker replacement (#628) (ded2ca9)
- config.ts で delay/timeout/spaWait=0 が正しく処理されるよう修正 (49d1263)
- store original element in processedElements for correct nest detection (#620) (530233d)
- Biome フォーマットエラーを修正 (#618) (15d33ca)
- remove unused writer2 variable in writer.test.ts (#588) (fd2e0ea)
- Biome lint エラー - writer.test.ts の未使用変数 (#586) (b6c52aa)
- preserve pages/ and specs/ directories in diff mode (#572) (ee598f1)
- --depth 0 が正しく動作しない問題を修正 (ec6ac94)
- 再クロール時にchunks/pages内の古いファイルを削除 (5ec9673)
- HTTPステータスコード200以外の正常レスポンスを受け入れる (7608bee)
- 差分クロール時に削除されたページをindex.jsonから除外 (9265dc9)
- フォールバック抽出のコードブロック検出をDOM操作ベースに変更 (b3da5bf)
- use HTML tag patterns for code block detection instead of substring matching (ab63b07)
- replace CSS selectors with HTML indicators in fallback detection (75f906a)
- HTTP ステータスコード判定を 200 のみから 2xx 範囲に緩和 (7d0fdb3)
- escape double quotes in YAML frontmatter keywords field (722a752)
- add non-null assertion for TypeScript type check (5681fc5)
- replace CSS selector string matching with HTML pattern regex (9550a51)
- filter out tel:, data:, blob:, ftp:, and file: URL schemes in extractLinks (5c6d303)
- writer.test.ts の non-null assertion を optional chain に置換 (5c8b16c)
- biome フォーマット修正 (runtime.test.ts) (0293478)
- warn when all output formats are disabled (4116e33)
- replace non-null assertion with optional chaining in writer test (126fc59)
- リンク抽出で tel:, data:, blob:, ftp: スキームを除外 (3fb6830)
- add integration test directory cleanup to global-teardown (694096d)
- global-teardown に integration テスト出力ディレクトリのクリーンアップを追加 (910fc7e)
- address Biome lint issues (4482a15)
- cleanup session on timeout in Fetcher.fetch() (9ed24c2)
- Chunkerのfrontmatter検出をファイル先頭のみに限定 (b6299b2)
- remove unused imports after chunkFullMd removal (935bc72)
- pages/*.mdのfrontmatterにhashフィールドを追加 (0e1cc4a)
- import を import type に変更（Biome lint警告対応） (5d45d6a)
- prevent undefined in PLAYWRIGHT_PATHS when HOME is not set (33dca04)
- abstract process.cwd() through RuntimeAdapter (78cb8a1)
- PlaywrightFetcher now returns actual Content-Type instead of hardcoded 'text/html' (fe52d4a)
- remove non-null assertion in fetcher.ts (2ac4cba)
- CI修正 - フォーマット対応 (c2fb26d)
- PlaywrightFetcher が実際の content-type を返すように修正 (500f536)
- Remove non-null assertion in fetcher timeout handling (766b948)
- apply Biome formatting to test file (52d1d34)
- remove non-null assertion in fetcher.ts (6c7f62a)
- docs/plans/ のトラッキング問題を修正 (42bad3c)
- CI修正 - lint/typecheck対応 (361e02c)
- enable parallel test execution by removing singleFork constraint (10f3ea3)
- ルートREADME.mdのドキュメントリンク切れ修正 (956930f)
- PlaywrightFetcher.fetch()のsetTimeoutタイマーリーク (b989ef6)
- PlaywrightFetcher の setTimeout タイマーリーク (eae9b4e)
- テスト間の分離（isolation）問題を修正 (d7450e3)
- vitest設定を整理し、既知の問題を文書化 (172c2be)
- vitest設定のクリーンアップと問題の明確化 (edb4a8e)
- テスト並列実行時のモジュールモック汚染を改善 (cec3015)
- テスト並列実行時のモジュールモック汚染を修正 (69de108)
- テスト並列実行時の分離問題を修正 (49b7b25)
- Update PlaywrightFetcher test to use session-stop command (1cb003c)
- vi.importActualをBun互換の方式に置き換え (e563044)
- IndexManager - vi.mock incomplete mock causing test failures (a66ef66)
- Biome lint - BunAPIの型を適用してas anyを削除 (9bcc6a4)
- node:fs モックが他のテストに影響する問題を修正 (66889a4)
- BunRuntimeAdapter - 依存性注入でテスト可能に (3a01e29)
- PostProcessor test - replace .resolves.not.toThrow() with direct await (6cbd8c9)
- format imports in links.test.ts (dbd4a8e)
- handle undefined title in @mozilla/readability 0.6.0 (6d1028c)
- update @mozilla/readability from 0.5.0 to 0.6.0 to fix DoS vulnerability (b9f3007)
- format console.warn call for Biome linter (8263e71)
- improve error handling in PostProcessor and Chunker (979792e)
- CI修正 - config.test.tsのエラーメッセージマッチング (5ffd898)
- CI修正 - TypeScript型エラー対応 (fad12c3)
- CI修正 - Biome lint対応 (6a4004e)
- Biome lint修正 - テンプレートリテラルとフォーマット (468950d)
- format code to pass Biome lint check (026d569)
- CI修正 - フォーマット対応 (b2a492e)
- CI修正 - フォーマット対応 (d7934bd)
- normalize path using node:path instead of unclear regex pattern (93cc2a6)
- biome設定でworktreeディレクトリを除外 (d8ecdc4)
- CI修正 - Biomeフォーマット対応 (b633ab5)
- CI修正 - Biome lint対応 (f3a53b3)
- CI修正 - Biomeフォーマット対応 (85fb29f)
- replace import.meta.dirname with fileURLToPath for Node.js compatibility (0fea10a)
- change SpawnResult.exitCode type from number to number | null (543fdf8)
- delete-environment スキルの外部スクリプト参照を削除し、内蔵実装に変更 (f4051c9)
- add -u option to install.sh for undefined variable detection (9a2fb6e)
- .pi/skills/delete-environment/SKILL.md を追加 (1043414)
- 008: Issue #1077 Already Resolved (2026-02-09) -> [詳細](docs/decisions/008-issue-1077-already-resolved.md)
- 007: Coverage Directory Already Untracked (2026-02-09) -> [詳細](docs/decisions/007-coverage-already-untracked.md)
- 006: スキル実行時の出力ディレクトリ問題 (2026-02-08) -> [詳細](docs/decisions/006-skill-output-directory.md)
- Decision Record 005: extractor.ts ブランチカバレッジ改善 -> [詳細](docs/decisions/005-issue-581-unreachable-code.md)
- 004: Issue #965 は Issue #961 と重複 (2026-02-08) -> [詳細](docs/decisions/004-issue-965-duplicate.md)
- docs/decisions/002-issue-946-duplicate.md -> [詳細](docs/decisions/002-issue-946-duplicate.md)
- docs/decisions/854-duplicate-of-848.md -> [詳細](docs/decisions/854-duplicate-of-848.md)

## 設計方針

- **playwright-cli統一**: 全サイト対応、SPA/静的の分岐なし
- **AIファースト出力**: `full.md` はLLMコンテキスト用
- **差分クロール**: `--diff` でハッシュベース変更検知

## 開発時の注意

- playwright-cliのバージョン変更時は [001](docs/decisions/001-playwright-cli-session.md) を確認
- テスト: `cd link-crawler && bun run test`
- 動作確認: `cd link-crawler && bun run src/crawl.ts https://example.com -d 1`

## 関連ドキュメント

- [docs/design.md](docs/design.md) - 詳細設計
- [docs/cli-spec.md](docs/cli-spec.md) - CLIオプション
- [docs/decisions/README.md](docs/decisions/README.md) - 意思決定ログ一覧（解決済み含む）
- [docs/decisions/](docs/decisions/) - 個別の意思決定ログ
